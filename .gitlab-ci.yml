stages:
  - setup
  - validation
  - analyze_sample_apps
  - backend_unit
  - backend_integration
  - backend_full_lifecycle
  - frontend

# The pipeline covers a series of triggers to ensure full testing and coverage

# Debug Stage
debug_merge_request:
  stage: setup
  script:
    - echo "Pipeline Source $CI_PIPELINE_SOURCE"
    - echo "Commit Branch (Source) $CI_COMMIT_REF_NAME"
    - echo "Target Branch (Merge Request) $CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
    - echo "Source Branch Name (Merge Request) $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
    - echo "Merge ID environment variable (Merge Request) $CI_MERGE_REQUEST_IID"

# Validate Conditional Triggers
validation_trigger:
  stage: validation
  trigger:
    include: tools/pipelines/child-ci-setup-validation.yml
  rules:
    # Condition 1: Branch is not main, qa, or development
    - if: '$CI_COMMIT_REF_NAME != "main" && $CI_COMMIT_REF_NAME != "qa" && $CI_COMMIT_REF_NAME != "development"'
      when: always

    # Condition 2: Triggered by a push event
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: always

    # Condition 3: Triggered by a merge request event (source branch is not "development")
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME != "development"'
      when: always

    # Condition 4: Triggered by a merge request event (source branch is "development", "qa", or "main")
    - if: '$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == "development" || $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == "qa" || $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == "main"'
      when: always

    # Fallback: Skip if no condition matches
    - when: never

# Analyze Conditional Triggers
analyze_flutter_mobile:
  stage: analyze_sample_apps
  trigger:
    include: tools/pipelines/child-ci-analyze-flutter-mobile.yml
  needs:
    - job: validation_trigger
  rules:
    # Always runs after validation trigger
    - when: always

    
# Unit Tests for Backend (Dev)
unit_test_dev:
  stage: backend_unit
  trigger:
    include: tools/pipelines/backend/child-ci-unit-tests-pre-dev.yml

# Integration Tests for Backend (Dev)
# integration_test_dev:
#  stage: backend_integration
#  trigger:
#    include: tools/pipelines/backend/child-ci-integration-tests-dev.yml

# Full Lifecycle Tests for Backend (Dev)
#full_lifecycle_dev:
#  stage: backend_full_lifecycle
#  trigger:
#    include: tools/pipelines/backend/child-ci-full-lifecycle-dev.yml

# Frontend Integration Tests (Run Simultaneously After Full Lifecycle)
# dart_web_integration_test_dev:
#   stage: frontend
#   trigger:
#     include: tools/pipelines/frontend/child-ci-dart-web-integration-test-dev.yml

# flutter_desktop_integration_test_dev:
#   stage: frontend
#   trigger:
#     include: tools/pipelines/frontend/child-ci-flutter-desktop-integration-test-dev.yml

# flutter_games_integration_test_dev:
#   stage: frontend
#   trigger:
#     include: tools/pipelines/frontend/child-ci-flutter-games-integration-test.yml

# flutter_mobile_integration_test_dev:
#   stage: frontend
#   trigger:
#     include: tools/pipelines/frontend/child-ci-flutter-mobile-integration-test-dev.yml

# flutter_web_integration_test_dev:
#   stage: frontend
#   trigger:
#     include: tools/pipelines/frontend/child-ci-flutter-web-integration-test-dev.yml

# react_integration_test_dev:
#   stage: frontend
#   trigger:
#     include: tools/pipelines/frontend/child-ci-react-integration-test-dev.yml

# svelte_integration_test_dev:
#   stage: frontend
#   trigger:
#     include: tools/pipelines/frontend/child-ci-svelte-integration-test-dev.yml

# vue_integration_test_dev:
#   stage: frontend
#   trigger:
#     include: tools/pipelines/frontend/child-ci-vue-integration-test-dev.yml
